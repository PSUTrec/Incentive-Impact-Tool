#E-Vehicle Incentive Impact Tool
#Server
#Mike McQueen

#Source helper scripts
source("util.R")

#Load Packages
library(shiny)
library(tidyr)
library(dplyr)
library(ggplot2)
library(units)
library(measurements)
library(stringr)



# Define server logic required calculate and draw plots
server <-  function(input, output, session) {
  
  #================================#
  #Plot Dimensions####
  #(These should be defined in UI)
  #================================#
  #cost per kg CO2 saved
  costperkg_x <- c(0, 5000)
  costperkg_y <- c(0, 4)
  
  #number of vehicles incentivized
  num_x <- c(0, 5e6)
  num_y <- c(0, 10000)
  
  #total CO2 saved
  CO2_saved_x <- c(0, 5e6)
  CO2_saved_y <- c(0, 1e7)
  
  #================================#
  #Text input value updaters####
  #================================#
  #~Update Trips panel with preset####
  observeEvent(input$apply_in_preset_Car_Trips_Daily_Avg, {
    updateNumericInput(session, inputId = "in_Car_Trips_Daily_Avg",
                       value = Trips %>%
                         filter(State == input$in_preset_Car_Trips_Daily_Avg) %>%
                         pull(Car_Trips_Daily_Avg)
    )
    updateNumericInput(session, inputId = "in_Car_Trip_Avg_Length",
                       value = drop_units(Trips %>%
                                            filter(State == input$in_preset_Car_Trips_Daily_Avg) %>%
                                            pull(Car_Trip_Avg_Length)
                       )
    )
  })
  #~Update Power Generation panel with preset####
  observeEvent(input$apply_in_preset_elec_gen_emissions, {
    updateNumericInput(session, inputId = "in_elec_gen_emissions",
                       value = drop_units(Electricity %>%
                                            filter(State == input$in_preset_elec_gen_emissions) %>%
                                            pull(CO2)
                       )
    )
  })
  
  #~Update IC panel with preset####
  observeEvent(input$apply_in_preset_IC_Fuel_Economy, {
    make_and_model = str_split(input$in_preset_IC_Fuel_Economy, " ")
    updateNumericInput(session, inputId = "in_IC_Fuel_Economy",
                       value = drop_units(IC %>%
                                            filter(Make == make_and_model[[1]][1],
                                                   Model == make_and_model[[1]][2]) %>%
                                            pull(Fuel_Economy)
                       )
    )
  })
  #~Update E-Bike panel with preset####
  observeEvent(input$apply_in_preset_EBike, {
    make_and_model = str_split(input$in_preset_EBike, " ")
    updateNumericInput(session, inputId = "in_EBike_Battery_Storage",
                       value = as.numeric(EBike %>%
                                            filter(Make == make_and_model[[1]][1],
                                                   Model == make_and_model[[1]][2]) %>%
                                            pull(Battery_Storage)
                       )
    )
    updateNumericInput(session, inputId = "in_EBike_Range",
                       value = as.numeric(EBike %>%
                                            filter(Make == make_and_model[[1]][1],
                                                   Model == make_and_model[[1]][2]) %>%
                                            pull(Range)
                       )
    )
  })
  #~Update BEV panel with preset####
  observeEvent(input$apply_in_preset_BEV, {
    updateNumericInput(session, inputId = "in_BEV_econ",
                       value = round(as.numeric(mix %>% 
                                                  filter(mix_type == "BEV",
                                                         mix_name == input$in_preset_BEV) %>% 
                                                  pull(epa_econ_wm)), 2))
  })
  #~Update PHEV panel with preset####
  observeEvent(input$apply_in_preset_PHEV, {
    updateNumericInput(session, inputId = "in_PHEV_elec_econ",
                       value = round(as.numeric(mix %>% 
                                                  filter(mix_type == "PHEV",
                                                         mix_name == input$in_preset_PHEV) %>% 
                                                  pull(epa_elec_econ_wm))))
    updateNumericInput(session, inputId = "in_PHEV_range_elec",
                       value = round(as.numeric(mix %>% 
                                                  filter(mix_type == "PHEV",
                                                         mix_name == input$in_preset_PHEV) %>% 
                                                  pull(range_elec_wm))))
    updateNumericInput(session, inputId = "in_PHEV_ic_econ",
                       value = round(as.numeric(mix %>%
                                                  filter(mix_type == "PHEV",
                                                         mix_name == input$in_preset_PHEV) %>% 
                                                  pull(epa_ic_econ_wm))))
  })
  #~Update FCEV panel with preset####
  observeEvent(input$apply_in_preset_FCEV, {
    updateNumericInput(session, inputId = "in_FCEV_econ",
                       value = round(as.numeric(mix %>% 
                                                  filter(mix_type == "FCEV",
                                                         mix_name == input$in_preset_FCEV) %>% 
                                                  pull(epa_h2_econ_wm)), 2))
  })
  
  #================================#
  #Calcs####
  #================================#
  
  #~IC####
  mileage_day <- reactive({
    Car_Trips_Daily_Avg <- input$in_Car_Trips_Daily_Avg
    Car_Trip_Avg_Length <- set_units(input$in_Car_Trip_Avg_Length, "mi")
    Car_Trips_Daily_Avg * Car_Trip_Avg_Length #calculate total mileage/day
  })
  IC_Fuel_Economy <- reactive({set_units(input$in_IC_Fuel_Economy, "mi / gal")})
  IC_emissions_year <- reactive({calc_IC_emissions_year(mileage_day(), IC_Fuel_Economy())}) #Calculate IC year emissions using helper function
  
  #~BEV####
  Elec_gen_emissions <- reactive({set_units(input$in_elec_gen_emissions, "pounds / megawatthour")})
  BEV_emissions_year <- reactive({calc_BEV_emissions_year(input$in_BEV_econ, Elec_gen_emissions(), mileage_day())}) #calculate BEV year emissions using helper function
  BEV_CO2_saved <- reactive({calc_BEV_CO2_saved(IC_emissions_year(), BEV_emissions_year())}) #Calculate BEV CO2 saved using helper function
  BEV_incentive <- reactive({input$in_BEV_incentive})
  
  #~PHEV####
  PHEV_emissions_year <- reactive({calc_PHEV_emissions_year(input$in_PHEV_elec_econ, input$in_PHEV_range_elec, input$in_PHEV_ic_econ, mileage_day(), Elec_gen_emissions())})
    #calculate PHEV year emissions using helper function
  PHEV_CO2_saved <- reactive({calc_PHEV_CO2_saved(IC_emissions_year(), PHEV_emissions_year())}) #calculate PHEV CO2 saved using helper function
  PHEV_incentive <- reactive({input$in_PHEV_incentive})
  
  #~FCEV####
  FCEV_emissions_year <- reactive({calc_FCEV_emissions_year(input$in_FCEV_econ, input$in_renew_energy_ratio, mileage_day(), Elec_gen_emissions())})
    #calculate FCEV year emissions using helper function
  FCEV_CO2_saved <- reactive({calc_FCEV_CO2_saved(IC_emissions_year(), FCEV_emissions_year())}) #calculate FCEV CO2 saved using helper function
  FCEV_incentive <- reactive({input$in_FCEV_incentive})
  
  #~E-Bike#####
  VMT_r <- reactive({input$in_EBike_VMT_r}) #Ratio of car mileage replaced by e-bike
  EBike_emissions_year <- reactive({calc_EBike_emissions_year(input$in_EBike_Battery_Storage, input$in_EBike_Range, Elec_gen_emissions(), mileage_day(), VMT_r())})
    #calculate E-Bike year emissions using helper function
  EBike_CO2_saved <- reactive({calc_EBike_CO2_saved(mileage_day(), VMT_r(), IC_Fuel_Economy(), IC_emissions_year(), EBike_emissions_year())})
    #calculate E-Bike CO2 saved using helper function
  EBike_incentive <- reactive({input$in_EBike_incentive})
  
  #~Cost/kg CO2 saved####
  costperkg <- reactive({ #done
    incentive_range = costperkg_x #Set the range of incentive dollar amounts
    BEV_costperkg <- tibble(mode = "BEV",
                            incentive = incentive_range,
                            costperkg = calc_costperkg(incentive_range, BEV_CO2_saved())) #Put these values in a tibble for plotting
    EBike_costperkg <- tibble(mode = "EBike",
                              incentive = incentive_range,
                              costperkg = calc_costperkg(incentive_range, EBike_CO2_saved())) #Put these values in a tibble for plotting
    PHEV_costperkg <- tibble(mode = "PHEV",
                             incentive = incentive_range,
                             costperkg = calc_costperkg(incentive_range, PHEV_CO2_saved())) #Put these values in a tibble for plotting
    FCEV_costperkg <- tibble(mode = "FCEV",
                             incentive = incentive_range,
                             costperkg = calc_costperkg(incentive_range, FCEV_CO2_saved())) #Put these values in a tibble for plotting
    
    tibble() %>% #combined table for plotting
      bind_rows(BEV_costperkg, EBike_costperkg, PHEV_costperkg, FCEV_costperkg) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #~~Pull specific points of interest####
  #Grab e-bike test point
  EBike_incentive_test_point <- reactive({
    #e-bike cost per kg CO2 saved
    EBike_costperkg <- calc_costperkg(incentive = EBike_incentive(), CO2_saved = EBike_CO2_saved())
    #e-bike incentive test point
    tibble(mode = "EBike", incentive = EBike_incentive(), costperkg = EBike_costperkg, CO2_saved = EBike_CO2_saved())
  })
  
  #Grab BEV test point
  BEV_incentive_test_point <- reactive({
    #BEV cost per kg CO2 saved
    BEV_costperkg <- calc_costperkg(incentive = BEV_incentive(), CO2_saved = BEV_CO2_saved())
    #BEV incentive test point
    tibble(mode = "BEV", incentive = BEV_incentive(), costperkg = BEV_costperkg, CO2_saved = BEV_CO2_saved())
  })
  
  #Grab PHEV test point
  PHEV_incentive_test_point <- reactive({
    #PHEV cost per kg CO2 saved
    PHEV_costperkg <- calc_costperkg(incentive = PHEV_incentive(), CO2_saved = PHEV_CO2_saved())
    #PHEV incentive test point
    tibble(mode = "PHEV", incentive = PHEV_incentive(), costperkg = PHEV_costperkg, CO2_saved = PHEV_CO2_saved())
  })
  
  #Grab FCEV test point
  FCEV_incentive_test_point <- reactive({
    #FCEV cost per kg CO2 saved
    FCEV_costperkg <- calc_costperkg(incentive = FCEV_incentive(), CO2_saved = FCEV_CO2_saved())
    #FCEV incentive test point
    tibble(mode = "FCEV", incentive = FCEV_incentive(), costperkg = FCEV_costperkg, CO2_saved = FCEV_CO2_saved())
  })
  
  #Bind all test points together for plotting
  test_points <- reactive({
    #bind to single testpoints tibble
    EBike_incentive_test_point() %>% 
      bind_rows(BEV_incentive_test_point(), PHEV_incentive_test_point(), FCEV_incentive_test_point()) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #================================#
  
  #~Total vehicles incentivized and total budget####
  num_incentivized <- reactive({
    total_budget_range = num_x
    BEV_num_incentivized = tibble(budget = total_budget_range,
                                  mode = "BEV",
                                  num = total_budget_range / BEV_incentive())
    EBike_num_incentivized = tibble(budget = total_budget_range,
                                    mode = "EBike",
                                    num = total_budget_range / EBike_incentive())
    PHEV_num_incentivized = tibble(budget = total_budget_range,
                                   mode = "PHEV",
                                   num = total_budget_range / PHEV_incentive())
    FCEV_num_incentivized = tibble(budget = total_budget_range,
                                   mode = "FCEV",
                                   num = total_budget_range / FCEV_incentive())
    tibble() %>% 
      bind_rows(BEV_num_incentivized, EBike_num_incentivized, PHEV_num_incentivized, FCEV_num_incentivized) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #~~Pull specific points of interest####
  test_budget_points <- reactive({
    test_budget <- input$in_test_budget
    BEV_budget_test_point <- tibble(mode = "BEV",
                                    budget = test_budget,
                                    num = budget / BEV_incentive())
    EBike_budget_test_point <- tibble(mode = "EBike",
                                      budget = test_budget,
                                      num = budget / EBike_incentive())
    PHEV_budget_test_point <- tibble(mode = "PHEV",
                                     budget = test_budget,
                                     num = budget / PHEV_incentive())
    FCEV_budget_test_point <- tibble(mode = "FCEV",
                                     budget = test_budget,
                                     num = budget / FCEV_incentive())
    EBike_budget_test_point %>% 
      bind_rows(BEV_budget_test_point, PHEV_budget_test_point, FCEV_budget_test_point) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #================================#
  
  #~Total CO2 saved per year and total budget####
  CO2_saved <- reactive({
    num_incentivized() %>% 
      mutate(CO2_saved = case_when(mode == "BEV" ~ num * BEV_CO2_saved(),
                                     mode == "EBike" ~ num * EBike_CO2_saved(),
                                     mode == "PHEV" ~ num * PHEV_CO2_saved(),
                                     mode == "FCEV" ~ num * FCEV_CO2_saved(),
                                     TRUE ~ 0)) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #~~Pull specific points of interest####
  test_budget_points_w_CO2 <- reactive({
    test_budget_points() %>% 
      left_join(test_points() %>% select(mode, CO2_saved), by = "mode") %>% #join CO2 saved per vehicle info
      mutate(total_CO2_saved = CO2_saved * num) %>% #calculated total CO2 saved
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include)   #Exclude items that are not selected in GUI
  })
  
  #================================#
  
  #~Budget Distribution Specific Total vehicles incentivized and total budget####
  num_incentivized_distrib <- reactive({
    total_budget_range = num_x
    BEV_num_incentivized = tibble(budget = total_budget_range,
                                  mode = "BEV",
                                  num = total_budget_range * (input$in_BEV_per_budget * .01) / BEV_incentive())
    EBike_num_incentivized = tibble(budget = total_budget_range,
                                    mode = "EBike",
                                    num = total_budget_range * (input$in_EBike_per_budget * .01) / EBike_incentive())
    PHEV_num_incentivized = tibble(budget = total_budget_range,
                                   mode = "PHEV",
                                   num = total_budget_range * (input$in_PHEV_per_budget * .01) / PHEV_incentive())
    FCEV_num_incentivized = tibble(budget = total_budget_range,
                                   mode = "FCEV",
                                   num = total_budget_range * (input$in_FCEV_per_budget * .01) / FCEV_incentive())
    tibble() %>% 
      bind_rows(BEV_num_incentivized, EBike_num_incentivized, PHEV_num_incentivized, FCEV_num_incentivized) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #~~Pull specific points of interest####
  test_budget_points_distrib <- reactive({
    test_budget <- input$in_test_budget
    BEV_budget_test_point <- tibble(mode = "BEV",
                                    budget = test_budget,
                                    budget_portion = (input$in_BEV_per_budget * .01) * test_budget,
                                    num = budget_portion / BEV_incentive())
    EBike_budget_test_point <- tibble(mode = "EBike",
                                      budget = test_budget,
                                      budget_portion = (input$in_EBike_per_budget * .01) * test_budget,
                                      num = budget_portion / EBike_incentive())
    PHEV_budget_test_point <- tibble(mode = "PHEV",
                                     budget = test_budget,
                                     budget_portion = (input$in_PHEV_per_budget * .01) * test_budget,
                                     num = budget_portion / PHEV_incentive())
    FCEV_budget_test_point <- tibble(mode = "FCEV",
                                     budget = test_budget,
                                     budget_portion = (input$in_FCEV_per_budget * .01) * test_budget,
                                     num = budget_portion / FCEV_incentive())

    EBike_budget_test_point %>% 
      bind_rows(BEV_budget_test_point, PHEV_budget_test_point, FCEV_budget_test_point) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #================================#
  
  #~Budget Distribution Specific Total CO2 saved per year and total budget####
  CO2_saved_distrib <- reactive({
    num_incentivized_distrib() %>% 
      mutate(CO2_saved = case_when(mode == "BEV" ~ num * BEV_CO2_saved(),
                                     mode == "EBike" ~ num * EBike_CO2_saved(),
                                     mode == "PHEV" ~ num * PHEV_CO2_saved(),
                                     mode == "FCEV" ~ num * FCEV_CO2_saved(),
                                     TRUE ~ 0)) %>% 
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #~~Pull specific points of interest####
  test_budget_points_w_CO2_distrib <- reactive({
    test_budget_points_distrib() %>% 
      left_join(test_points() %>% select(mode, CO2_saved), by = "mode") %>% #join per vehicle CO2 saved info
      mutate(total_CO2_saved = num * CO2_saved) %>% #calculate total CO2 saved info
      exclude_items(input$in_EBike_include, input$in_PHEV_include, input$in_BEV_include, input$in_FCEV_include) #Exclude items that are not selected in GUI
  })
  
  #================================#
  #Plots####
  #================================#
  #~Cost per kg CO2 saved by mode####
  output$g1 <- renderPlot({
    g1plot(costperkg(), test_points(), costperkg_x, costperkg_y)
  })
  #~Number incentivized####
  output$g2 <- renderPlot({
    g2plot(num_incentivized(), test_budget_points(), num_x, num_y)
  })
  #~CO2 saved####
  output$g3 <- renderPlot({
    g3plot(CO2_saved(), test_budget_points_w_CO2(), num_incentivized(), CO2_saved_x, CO2_saved_y)
  })
  #~Budget distribution specific number incentivized####
  output$g4 <- renderPlot({
    g4plot(num_incentivized(), num_incentivized_distrib(), test_budget_points_distrib(), num_x, num_y)
  })
  #~Budget distribution specific CO2 saved####
  output$g5 <- renderPlot({
    g5plot(num_incentivized(), CO2_saved_distrib(), test_budget_points_w_CO2_distrib(), CO2_saved_x, CO2_saved_y)
  })
  #~Plot to show percentage of budget used####
  output$g_budget_total <- renderPlot({
    total <-  sum(input$in_BEV_per_budget, input$in_EBike_per_budget, input$in_PHEV_per_budget, input$in_FCEV_per_budget)
    #Make it red if the total is more than 100
    color <- if (total > 100) {
      "red"
    } else if (total == 100) {
      "green"
      } else ("blue")
    #Build plot
    barplot(total, ylim = c(0,120), main = paste(total, "% Used", sep = ""), col = color)
  })
  #~Generate a downloadable report####
  output$report <- downloadHandler(
    filename = "report.html",
    content = function(file) {
      #copy report file to temporary directory before processing it
      tempReport <- file.path(tempdir(), "report.Rmd")
      file.copy("report.Rmd", tempReport, overwrite = TRUE)
      
      #Set up parameters to pass to Rmd document
      params <- reactiveValuesToList(input)
      
      #Knit the document, passing in the 'params' list,
      #and eval it in a child of the global environement
      #(this isolates the codes in the document from the code in this app)
      rmarkdown::render(tempReport, output_file = file,
                        params = list(Car_Trip_Avg_Length = input$in_Car_Trip_Avg_Length,
                                      EBike_per_budget = input$in_EBike_per_budget,
                                      test_budget = input$in_test_budget,
                                      PHEV_incentive = input$in_PHEV_incentive,
                                      BEV_econ = input$in_BEV_econ,
                                      FCEV_incentive = input$in_FCEV_incentive,
                                      preset_FCEV = input$in_preset_FCEV,
                                      FCEV_include = input$in_FCEV_include,
                                      preset_EBike = input$in_preset_EBike,
                                      EBike_include = input$in_EBike_include,
                                      BEV_incentive = input$in_BEV_incentive,
                                      EBike_Battery_Storage = input$in_EBike_Battery_Storage,
                                      EBike_incentive = input$in_EBike_incentive,
                                      EBike_Range = input$in_EBike_Range,
                                      BEV_per_budget = input$in_BEV_per_budget,
                                      EBike_VMT_r = input$in_EBike_VMT_r,
                                      preset_Car_Trips_Daily_Avg = input$in_preset_Car_Trips_Daily_Avg,
                                      FCEV_econ = input$in_FCEV_econ,
                                      PHEV_elec_econ = input$in_PHEV_elec_econ,
                                      PHEV_range_elec = input$in_PHEV_range_elec,
                                      preset_PHEV = input$in_preset_PHEV,
                                      BEV_include = input$in_BEV_include,
                                      elec_gen_emissions = input$in_elec_gen_emissions,
                                      preset_elec_gen_emissions = input$in_preset_elec_gen_emissions,
                                      PHEV_per_budget = input$in_PHEV_per_budget,
                                      preset_BEV = input$in_preset_BEV,
                                      FCEV_per_budget = input$in_FCEV_per_budget,
                                      IC_Fuel_Economy = input$in_IC_Fuel_Economy,
                                      Car_Trips_Daily_Avg = input$in_Car_Trips_Daily_Avg,
                                      PHEV_ic_econ = input$in_PHEV_ic_econ,
                                      renew_energy_ratio = input$in_renew_energy_ratio,
                                      PHEV_include = input$in_PHEV_include,
                                      preset_IC_Fuel_Economy = input$in_preset_IC_Fuel_Economy,
                                      costperkg = costperkg(),
                                      costperkg_x = costperkg_x,
                                      costperkg_y = costperkg_y,
                                      test_points = test_points(),
                                      num_incentivized = num_incentivized(),
                                      test_budget_points = test_budget_points(),
                                      num_x = num_x,
                                      num_y = num_y,
                                      CO2_saved = CO2_saved(),
                                      test_budget_points_w_CO2 = test_budget_points_w_CO2(),
                                      CO2_saved_x = CO2_saved_x,
                                      CO2_saved_y = CO2_saved_y,
                                      num_incentivized_distrib = num_incentivized_distrib(),
                                      test_budget_points_distrib = test_budget_points_distrib(),
                                      CO2_saved_distrib = CO2_saved_distrib(),
                                      test_budget_points_w_CO2_distrib = test_budget_points_w_CO2_distrib()
                                      ),
                        envir = new.env(parent = globalenv())
                        )
    }
  )
}